<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GrammarGenius - AI Language Learning Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --accent: #fbbf24;
            --background: #faf9ff;
            --card-bg: #ffffff;
            --text: #1e293b;
            --muted-text: #64748b;
            --border-color: #e2e8f0;
            --hover-shadow: rgba(139, 92, 246, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        body.dark {
            --primary: #a78bfa;
            --primary-light: #c4b5fd;
            --accent: #fcd34d;
            --background: #1e293b;
            --card-bg: #2d394b;
            --text: #f1f5f9;
            --muted-text: #a8b0be;
            --border-color: #3e4c5b;
            --hover-shadow: rgba(167, 139, 250, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.25);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.35);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background);
            color: var(--text);
            transition: background 0.4s ease, color 0.4s ease;
            min-height: 100vh;
        }
        .container {
            width: min(1200px, 92%);
            margin: 0 auto;
            padding: 2rem 0;
        }
        .header {
            padding: 40px 24px;
            text-align: center;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            border-radius: 0 0 24px 24px;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        .header p {
            margin: 8px 0 0;
            font-size: 1rem;
            opacity: 0.9;
        }
        nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 999px;
            padding: 6px;
            display: inline-flex;
            gap: 4px;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
        }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 999px;
            font-weight: 500;
            transition: 0.3s ease;
            position: relative;
            z-index: 1;
        }
        .nav-link.active, .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
        }
        .nav-link.active::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: -1;
            transform: scale(1.05);
            transition: 0.3s ease;
        }
        .dark-mode-toggle {
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text);
            padding: 8px;
            border-radius: 999px;
            background: var(--card-bg);
            transition: 0.3s;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
        .dark-mode-toggle:hover {
            transform: translateY(-2px) scale(1.05);
        }
        .main-content {
            padding: 24px;
            position: relative;
            margin-top: 20px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        .card-header {
            padding: 16px 24px;
            font-weight: 600;
            background: var(--background);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary);
        }
        .skill-level {
            font-size: 0.9rem;
            font-weight: 500;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 999px;
        }
        .card-body {
            padding: 24px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .card-footer {
            border-top: 1px solid var(--border-color);
            padding: 16px 24px;
            background: var(--background);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .chat-box {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-empty {
            color: var(--muted-text);
            text-align: center;
            padding: 40px;
        }
        .msg-container {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-msg {
            margin-left: auto;
            background: var(--primary-light);
            color: white;
            padding: 12px 18px;
            border-radius: 20px 20px 4px 20px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: var(--shadow-md);
        }
        .ai-msg {
            margin-right: auto;
            background: var(--card-bg);
            color: var(--text);
            padding: 12px 18px;
            border-radius: 20px 20px 20px 4px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        .ai-corrected { font-weight: 600; margin-bottom: 8px; }
        .ai-explanation { font-size: 0.9rem; color: var(--muted-text); margin-top: 8px; }
        .wrong-word {
            background: #fecaca;
            color: #b91c1c;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 500;
        }
        body.dark .wrong-word { background: #451a03; color: #fca5a5; }
        .correct-word {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 500;
        }
        body.dark .correct-word { background: #14532d; color: #a7f3d0; }
        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .input-group input[type="text"], .input-group select {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            transition: 0.3s;
        }
        .input-group input[type="text"]:focus, .input-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            border: 2px solid transparent;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        .btn-icon {
            background: transparent;
            color: var(--muted-text);
            padding: 10px;
            border: none;
            border-radius: 12px;
        }
        .btn-icon:hover {
            background: var(--border-color);
            color: var(--text);
        }
        #typing-indicator {
            display: none;
            align-items: center;
            gap: 6px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--muted-text);
            border-radius: 50%;
            animation: blink 1.3s infinite both;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        .welcome-container {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 24px;
        }
        .welcome-container h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text);
        }
        .welcome-container p {
            font-size: 1.1rem;
            color: var(--muted-text);
            max-width: 600px;
            margin: 0 auto;
        }
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .tip-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            text-align: left;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: var(--shadow-md);
        }
        .tip-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        .tip-card span {
            font-size: 1.5rem;
            margin-right: 12px;
        }
        .tip-card p {
            margin: 0;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .flex { display: flex; align-items: center; }
        .flex-row-reverse { flex-direction: row-reverse; }
        .flex-col { flex-direction: column; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb {
            background-color: var(--primary-light);
            border-radius: 4px;
            border: 2px solid var(--card-bg);
        }
        body.dark ::-webkit-scrollbar-thumb { border-color: var(--background); }
        .exercise-options button {
            background: var(--background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            margin-right: 8px;
            cursor: pointer;
        }
        .exercise-options button.correct {
            background: #d1fae5;
        }
        .exercise-options button.incorrect {
            background: #fecaca;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="dark-mode-toggle" id="dark-toggle" title="Toggle dark mode">üåô</div>
    <div class="header flex flex-col justify-center">
        <h1>GrammarGenius</h1>
        <p>Master any language with AI-powered conversations and smart learning</p>
        <nav class="flex justify-center">
            <a class="nav-link active" href="#" data-tab="chat-tab">Chat</a>
            <a class="nav-link" href="#" data-tab="history-tab">History</a>
            <a class="nav-link" href="#" data-tab="settings-tab">Settings</a>
        </nav>
    </div>
    <div class="container main-content">
        <div id="chat-tab" class="tab-content active">
            <div id="welcome-section" class="welcome-container">
                <h1>Welcome to GrammarGenius</h1>
                <p>Your personal AI language tutor is here to help you practice and improve your skills. Let's get started!</p>
                <div id="tips-section" class="tips-grid">
                    <div class="tip-card flex" onclick="sendTip('Tell me about your day.')">
                        <span>üí¨</span>
                        <p>Tell me about your day.</p>
                    </div>
                    <div class="tip-card flex" onclick="sendTip('What's the weather like today?')">
                        <span>‚òÅÔ∏è</span>
                        <p>What's the weather like today.</p>
                    </div>
                    <div class="tip-card flex" onclick="sendTip('What are some interesting places to visit in Paris?')">
                        <span>üó∫Ô∏è</span>
                        <p>What are some interesting places to visit in Paris?</p>
                    </div>
                    <div class="tip-card flex" onclick="sendTip('Can you explain a new grammar rule?')">
                        <span>‚úçÔ∏è</span>
                        <p>Can you explain a new grammar rule?</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Chat with Your AI Tutor</h3>
                    <div class="flex gap-2">
                        <span class="skill-level" id="skill-level">Skill: Beginner</span>
                        <select id="persona-select">
                            <option value="Friendly Tutor" selected>Friendly Tutor</option>
                            <option value="Strict Professor">Strict Professor</option>
                            <option value="Casual Friend">Casual Friend</option>
                        </select>
                    </div>
                </div>
                <div class="card-body chat-box" id="chat-box">
                    <div class="chat-empty">Start speaking or typing to practice‚Ä¶</div>
                </div>
                <div class="card-footer">
                    <div id="typing-indicator" class="flex gap-2">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="user-input" placeholder="Type your message‚Ä¶" />
                        <select id="lang-select">
                            <option value="en-US" selected>English</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ur-PK">Urdu (Pakistan)</option>
                        </select>
                        <button id="send-btn" class="btn btn-primary">Send</button>
                        <button id="mic-btn" class="btn btn-icon">üé§</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="history-tab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="card-header"><h3>Chat History</h3></div>
                <div class="card-body" id="history-box">
                    <div class="chat-empty">No history yet.</div>
                </div>
                <div class="card-footer">
                    <button id="clear-history-btn" class="btn" style="background:#ef4444; color:white; border-color:#ef4444;">Clear History</button>
                </div>
            </div>
        </div>
        <div id="settings-tab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="card-header"><h3>Settings</h3></div>
                <div class="card-body flex flex-col gap-4">
                    <div>
                        <label for="voice-rate" class="muted-text">Voice Rate</label><br>
                        <input type="range" min="0.5" max="2" step="0.1" id="voice-rate" value="1">
                    </div>
                    <div>
                        <label for="voice-pitch" class="muted-text">Voice Pitch</label><br>
                        <input type="range" min="0.5" max="2" step="0.1" id="voice-pitch" value="1">
                    </div>
                    <div>
                        <label for="default-lang" class="muted-text">Default Language</label><br>
                        <select id="default-lang">
                            <option value="en-US" selected>English</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ur-PK">Urdu (Pakistan)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let recognition, isRecording = false;
        let chatHistory = JSON.parse(localStorage.getItem('gg_history') || '[]');
        let voiceRate = parseFloat(localStorage.getItem('gg_rate') || '1');
        let voicePitch = parseFloat(localStorage.getItem('gg_pitch') || '1');
        let currentAudio = null;
        let accuracyWindow = JSON.parse(localStorage.getItem('gg_accuracy') || '[]');
        const chatBox = document.getElementById('chat-box');
        const historyBox = document.getElementById('history-box');
        const typingIndicator = document.getElementById('typing-indicator');
        const skillBadge = document.getElementById('skill-level');
        const welcomeSection = document.getElementById('welcome-section');
        const tipsSection = document.getElementById('tips-section');
        const darkToggle = document.getElementById('dark-toggle');
        if (localStorage.getItem('gg_dark') === 'true') {
            document.body.classList.add('dark');
            darkToggle.textContent = '‚òÄÔ∏è';
        }
        darkToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('gg_dark', isDark ? 'true' : 'false');
            darkToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const id = link.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
                document.getElementById(id).style.display = 'block';
                if (id === 'history-tab') renderHistory();
            });
        });
        document.getElementById('voice-rate').value = voiceRate;
        document.getElementById('voice-pitch').value = voicePitch;
        document.getElementById('voice-rate').addEventListener('input', function() {
            voiceRate = parseFloat(this.value);
            localStorage.setItem('gg_rate', voiceRate);
        });
        document.getElementById('voice-pitch').addEventListener('input', function() {
            voicePitch = parseFloat(this.value);
            localStorage.setItem('gg_pitch', voicePitch);
        });
        document.getElementById('default-lang').addEventListener('change', function() {
            document.getElementById('lang-select').value = this.value;
        });
        document.getElementById('send-btn').addEventListener('click', () => sendUserMessage());
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendUserMessage();
        });
        document.getElementById('mic-btn').addEventListener('click', toggleRecording);
        document.getElementById('clear-history-btn').addEventListener('click', clearHistory);
        function sendTip(text) {
            document.getElementById('user-input').value = text;
            sendUserMessage();
        }
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
        }
        function speakAIResponse(text, lang) {
            if ('speechSynthesis' in window) {
                stopSpeech();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = voiceRate;
                u.pitch = voicePitch;
                window.speechSynthesis.speak(u);
            }
        }
        function playAudio(url) {
            if (!url) return;
            stopSpeech();
            currentAudio = new Audio(url);
            currentAudio.play().catch(e => console.error('Audio play error:', e));
        }
        async function sendUserMessage(msgText = null) {
            stopSpeech();
            const msg = msgText ?? document.getElementById('user-input').value.trim();
            const lang = document.getElementById('lang-select').value;
            const persona = document.getElementById('persona-select').value;
            if (!msg) return;

            if (welcomeSection) welcomeSection.style.display = 'none';
            if (tipsSection) tipsSection.style.display = 'none';

            appendUserMessage(msg);
            document.getElementById('user-input').value = '';
            typingIndicator.style.display = 'flex';

            // FIX: Correctly structure chat history to send to backend
            const chatHistoryForBackend = chatHistory
                .filter(item => item.type === 'user' || item.type === 'ai')
                .map(item => {
                    if (item.type === 'user') {
                        return { user: item.text, ai: null };
                    } else {
                        // Find the corresponding user message in history
                        const lastUser = chatHistory.slice().reverse().find(i => i.type === 'user' && i.time < item.time);
                        return { user: lastUser ? lastUser.text : null, ai: item.reply.corrected_text };
                    }
                })
                .filter(item => item.user && item.ai) // Only send complete turns
                .slice(-5); // Only send the last 5 turns


            const response = await fetch("http://127.0.0.1:5000/api/message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: msg, lang: lang, persona: persona, chat_history: chatHistoryForBackend })
            }).then(r => r.json()).catch(err => {
                console.error(err);
                return { reply: { corrected_text: 'Something went wrong. Try again.' } };
            });

            typingIndicator.style.display = 'none';
            const aiReply = response.reply || { corrected_text: '(No response)', explanation: '', vocabulary_tips: '' };
            const diff = diffWords(msg, aiReply.corrected_text || '');
            const mistakePairs = buildMistakePairs(diff);

            appendAIMessage(aiReply, mistakePairs);

            chatHistory.push({ type: 'user', text: msg, time: new Date().toISOString() });
            chatHistory.push({ type: 'ai', reply: aiReply, mistakes: mistakePairs, time: new Date().toISOString() });
            localStorage.setItem('gg_history', JSON.stringify(chatHistory));

            updateSkill(diff);

            let toSpeak = '';
            if (aiReply.corrected_text) toSpeak += `Corrected version: ${aiReply.corrected_text}. `;
            if (aiReply.explanation) toSpeak += `Explanation: ${aiReply.explanation}. `;
            if (aiReply.vocabulary_tips) toSpeak += `Vocabulary tip: ${aiReply.vocabulary_tips}.`;

            if (toSpeak) {
                fetch("http://127.0.0.1:5000/api/tts", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: toSpeak, lang: lang })
                }).then(r => r.json()).then(audio => {
                    if (audio && audio.audio_url) {
                        playAudio(audio.audio_url);
                    } else {
                        speakAIResponse(toSpeak, lang);
                    }
                }).catch(() => speakAIResponse(toSpeak, lang));
            }
        }
        function appendUserMessage(text) {
            removeEmptyState();
            const div = document.createElement('div');
            div.className = 'msg-container user-message';
            div.innerHTML = `<div class="user-msg">${escapeHtml(text)}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function appendAIMessage(reply, mistakes) {
            removeEmptyState();
            const correctedHTML = escapeHtml(reply.corrected_text || '‚Äî');
            const explanationHTML = reply.explanation ? `<div class="ai-explanation">üí° ${escapeHtml(reply.explanation)}</div>` : '';
            const vocabHTML = reply.vocabulary_tips ? `<span class="ai-vocab">üìö ${escapeHtml(reply.vocabulary_tips)}</span>` : '';
            const mistakesHTML = (mistakes && mistakes.length) ?
                `<div class="mistakes-wrap">
                    ${mistakes.map(p => `<span class="wrong-word">${escapeHtml(p.wrong)}</span> ‚Üí <span class="correct-word">${escapeHtml(p.right)}</span>`).join(' ')}
                </div>` : '';

            const exerciseBtn = reply.corrected_text ? `<button class="btn btn-primary" onclick="generateExercise('${escapeBackticks(reply.corrected_text)}', '${document.getElementById('lang-select').value}')">Generate Exercise</button>` : '';

            const div = document.createElement('div');
            div.className = 'msg-container ai-message';
            div.innerHTML = `
                <div class="ai-msg">
                    <div class="ai-corrected flex gap-2 items-center">
                        ‚úÖ <span>${correctedHTML}</span>
                        <button class="btn-icon" title="Copy" onclick="copyText(\`${escapeBackticks(reply.corrected_text || '')}\`)">üìã</button>
                    </div>
                    ${mistakesHTML}
                    ${explanationHTML}
                    ${vocabHTML ? `<div style="margin-top:6px">${vocabHTML}</div>` : ''}
                    <div style="margin-top:12px">${exerciseBtn}</div>
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        async function generateExercise(correctedText, lang) {
            const exerciseBtn = event.target;
            exerciseBtn.disabled = true;
            exerciseBtn.textContent = 'Generating...';

            const response = await fetch("http://127.0.0.1:5000/api/exercise", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ corrected_text: correctedText, lang: lang })
            }).then(r => r.json()).catch(err => {
                console.error(err);
                return { exercise: { error: "Failed to load exercise." } };
            });

            if (response.exercise && !response.exercise.error) {
                appendExerciseMessage(response.exercise);
            } else {
                alert(response.exercise.error);
            }
            exerciseBtn.disabled = false;
            exerciseBtn.textContent = 'Generate Exercise';
        }
        function appendExerciseMessage(exercise) {
            const exerciseHTML = `
                <div class="ai-msg">
                    <div style="font-weight:600">üìù Exercise:</div>
                    <div style="margin-top:8px">${escapeHtml(exercise.exercise_text.replace('___', '<span style="color:var(--primary)">_____</span>'))}</div>
                    <div class="exercise-options" style="margin-top:12px;">
                        ${shuffleArray(exercise.options).map(option => `
                            <button onclick="checkAnswer(this, '${escapeBackticks(option)}', '${escapeBackticks(exercise.correct_answer)}')" class="btn">${escapeHtml(option)}</button>
                        `).join('')}
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.className = 'msg-container ai-message';
            div.innerHTML = exerciseHTML;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function checkAnswer(button, selected, correct) {
            const container = button.closest('.exercise-options');
            container.querySelectorAll('button').forEach(btn => btn.disabled = true);
            if (selected === correct) {
                button.classList.add('correct');
                setTimeout(() => {
                    alert('Correct! üéâ');
                    container.classList.add('hidden');
                }, 500);
            } else {
                button.classList.add('incorrect');
                const correctButton = Array.from(container.querySelectorAll('button')).find(btn => btn.textContent === correct);
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
                setTimeout(() => alert(`Incorrect. The correct answer was "${correct}".`), 500);
            }
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        function groupByDate(items) {
            const map = {};
            items.forEach(i => {
                const d = new Date(i.time);
                const key = d.toLocaleDateString();
                if (!map[key]) map[key] = [];
                map[key].push(i);
            });
            return map;
        }
        function clearHistory() {
            chatHistory = [];
            localStorage.setItem('gg_history', '[]');
            renderHistory();
        }
        function renderHistory() {
            if (chatHistory.length === 0) {
                historyBox.innerHTML = `<div class="chat-empty">No history yet.</div>`;
                return;
            }
            const groups = groupByDate(chatHistory);
            let html = '';
            Object.keys(groups).forEach(date => {
                html += `<div class="date-chip" style="text-align:center; padding:10px; color:var(--muted-text);">${date}</div>`;
                groups[date].forEach((item, idx) => {
                    if (item.type === 'user') {
                        html += `<div class="history-item card" style="margin-bottom:10px;"><strong>User:</strong> ${escapeHtml(item.text)}</div>`;
                    } else {
                        const ct = item.reply?.corrected_text || '';
                        html += `<div class="history-item card" style="margin-bottom:10px;"><strong>AI:</strong> ${escapeHtml(ct)}</div>`;
                    }
                });
            });
            historyBox.innerHTML = html;
        }
        function updateSkill(diff) {
            const totals = diff.reduce((acc, d) => {
                acc.total += d.count;
                if (d.op === 'equal') acc.ok += d.count;
                return acc;
            }, { ok: 0, total: 0 });
            const acc = totals.total ? (totals.ok / totals.total) : 1;
            accuracyWindow.push(acc);
            if (accuracyWindow.length > 12) accuracyWindow.shift();
            localStorage.setItem('gg_accuracy', JSON.stringify(accuracyWindow));
            const avg = accuracyWindow.reduce((a, b) => a + b, 0) / accuracyWindow.length;
            let label = 'Beginner';
            if (avg >= 0.85) label = 'Advanced';
            else if (avg >= 0.65) label = 'Intermediate';
            skillBadge.textContent = `Skill: ${label}`;
        }
        function tokenizeWords(s) {
            return s.trim().split(/\s+/).filter(Boolean);
        }
        function diffWords(a, b) {
            const A = tokenizeWords(a), B = tokenizeWords(b);
            const m = A.length, n = B.length;
            const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    dp[i][j] = (A[i - 1] === B[j - 1]) ? dp[i - 1][j - 1] + 1 : Math.max(dp[i - 1][j], dp[i][j - 1]);
                }
            }
            const out = [];
            let i = m, j = n;
            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && A[i - 1] === B[j - 1]) {
                    out.push({ op: 'equal', text: A[i - 1], count: 1 });
                    i--;
                    j--;
                } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                    out.push({ op: 'add', text: B[j - 1], count: 1 });
                    j--;
                } else {
                    out.push({ op: 'del', text: A[i - 1], count: 1 });
                    i--;
                }
            }
            out.reverse();
            const merged = [];
            for (const t of out) {
                const last = merged[merged.length - 1];
                if (last && last.op === t.op) {
                    last.text += ' ' + t.text;
                    last.count += t.count;
                } else merged.push({...t});
            }
            return merged;
        }
        function buildMistakePairs(diff) {
            const pairs = [];
            let bufferDel = null;
            diff.forEach(seg => {
                if (seg.op === 'del') {
                    bufferDel = (bufferDel ? bufferDel + ' ' : '') + seg.text;
                } else if (seg.op === 'add' && bufferDel) {
                    pairs.push({ wrong: bufferDel, right: seg.text });
                    bufferDel = null;
                } else if (seg.op === 'equal') {
                    bufferDel = null;
                }
            });
            return pairs;
        }
        function removeEmptyState() {
            const empty = chatBox.querySelector('.chat-empty');
            if (empty) empty.remove();
        }
        function copyText(t) {
            navigator.clipboard.writeText(t).then(() => {
                const el = document.createElement('div');
                el.textContent = 'Copied!';
                el.style.position = 'fixed';
                el.style.bottom = '20px';
                el.style.left = '50%';
                el.style.transform = 'translateX(-50%)';
                el.style.background = 'var(--primary)';
                el.style.color = '#fff';
                el.style.padding = '8px 12px';
                el.style.borderRadius = '10px';
                el.style.boxShadow = '0 4px 12px rgba(0,0,0,.2)';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 900);
            });
        }
        function escapeHtml(s) {
            return (s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
        }
        function escapeBackticks(s) {
            return (s ?? '').replace(/`/g, '\\`');
        }
        function toggleRecording() {
            if (!('webkitSpeechRecognition' in window)) return alert('Speech recognition not supported in this browser.');
            stopSpeech();
            if (!isRecording) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = document.getElementById('lang-select').value;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('mic-btn').classList.add('active');
                };
                recognition.onresult = function(event) {
                    const last = event.results.length - 1;
                    const text = event.results[last][0].transcript;
                    document.getElementById('user-input').value = text;
                    sendUserMessage();
                };
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    isRecording = false;
                    document.getElementById('mic-btn').classList.remove('active');
                };
                recognition.onend = function() {
                    isRecording = false;
                    document.getElementById('mic-btn').classList.remove('active');
                };
                recognition.start();
            } else {
                recognition.stop();
            }
        }
    </script>
</body>
</html>